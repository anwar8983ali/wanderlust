<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Wanderlust Listings</title>
<link rel="stylesheet" href="styles.css">
<script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
</head>
<body>

<% layout('layouts/boilerPlate') %>

<!-- Search Input -->
<div style="margin: 2rem;">
  <input type="text" id="searchInput" placeholder="Search listings..." style="padding:0.5rem; width: 300px;">
</div>

<!-- Filters -->
<div id="filters">
   <!-- ... all your filter divs here ... -->
</div>

<!-- Original Listings Container -->
<div class="row row-cols-lg-3 row-cols-md-2 row-cols-sm-1 mt-3">
  <% for (let listing of allListings) {
       if (!listing._id || !listing.image || !listing.image.url) continue;
  %>
    <a href="/listings/<%= listing._id %>" class="listing-link">
      <div class="card listing-card">
        <img src="<%= listing.image.url %>" class="card-img-top" alt="listingImage" style="height:20rem;">
        <div class="card-img-overlay"></div>
        <div class="card-body">
          <p class="card-text">
            <b><%= listing.title %></b><br>
            &#8377; <%= listing.price.toLocaleString("en-IN") %>/night
            <i class="tax-info">  &nbsp;&nbsp;+18% GST</i>
          </p>
        </div>
      </div>
    </a>
  <% } %>
</div>

<!-- Search Results Container -->
<div id="searchResults" class="row row-cols-lg-3 row-cols-md-2 row-cols-sm-1 mt-3"></div>

<!-- Scripts -->
<script>
// Tax Toggle
let taxSwitch=document.getElementById('switchCheckDefault');
taxSwitch.addEventListener('click',()=>{
  let taxInfo=document.getElementsByClassName('tax-info');
  for(info of taxInfo){
    info.style.display = info.style.display !== "inline" ? "inline" : "none";
  }
});

// Live Search
let timeout;
const searchInput = document.getElementById('searchInput');
const searchResultsDiv = document.getElementById('searchResults');
const listingsContainer = document.querySelector('.row'); // original allListings container

searchInput.addEventListener('input', () => {
  clearTimeout(timeout);
  timeout = setTimeout(() => performSearch(), 300); // 300ms debounce
});

async function performSearch() {
  const query = searchInput.value.trim();

  if (!query) {
    searchResultsDiv.innerHTML = '';
    listingsContainer.style.display = 'flex';
    return;
  }

  listingsContainer.style.display = 'none';

  try {
    const res = await fetch(`/search?query=${encodeURIComponent(query)}`);
    const listings = await res.json();

    if (listings.length === 0) {
      searchResultsDiv.innerHTML = "<p>No results found</p>";
      return;
    }

    searchResultsDiv.innerHTML = listings.map(l => `
      <a href="/listings/${l._id}" class="listing-link">
        <div class="card listing-card">
          <img src="${l.image?.url || 'default.jpg'}" class="card-img-top" alt="${l.title}" style="height:20rem;">
          <div class="card-img-overlay"></div>
          <div class="card-body">
            <p class="card-text">
              <b>${l.title}</b><br>
              &#8377; ${l.price?.toLocaleString("en-IN") || 'N/A'}/night
              <i class="tax-info">  &nbsp;&nbsp;+18% GST</i>
            </p>
          </div>
        </div>
      </a>
    `).join('');

  } catch (err) {
    searchResultsDiv.innerHTML = "<p>Error fetching results</p>";
  }
}
</script>

</body>
</html>
